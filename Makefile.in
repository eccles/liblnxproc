#--------------------------------------------------------------------
# @configure_input@
#--------------------------------------------------------------------
package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = @PACKAGE_TARNAME@
distdir = $(tarname)-$(version)
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
datarootdir = @datarootdir@
includedir = @includedir@
libdir = @libdir@
mandir = @mandir@
sysconfdir = @sysconfdir@
#--------------------------------------------------------------------

FILES=CREDITS LICENSE.txt NOTES README README.md TODO configure.ac
SCRIPTS=format.sh genchanges.sh splint.conf submit.sh configure
MANDIR=man
SRCDIR=src
TESTDIR=test
INCDIR=include
HDRDIR=include/$(package)
DATADIR=proc sys var
DIRS=$(MANDIR) $(SRCDIR) $(TESTDIR) $(INCDIR)
all install uninstall:
	for d in $(DIRS); do (cd $$d; $(MAKE) $@ ); done

check: all
	cd $(TESTDIR) && ./topiary.sh test nodbg
	@echo "*** All tests passed ***"

clean:
	for d in $(DIRS); do (cd $$d; $(MAKE) $@ ); done
	-rm -rf $(distdir) $(distdir).tar.gz x y z

dist: $(distdir).tar.gz

$(distdir).tar.gz: $(distdir)
	tar chof - $(distdir) | gzip -9 -c > $@
	rm -rf $(distdir)

$(distdir)/$(SRCDIR):
	mkdir -p $@
	cp $(SRCDIR)/Makefile.in $@
	cp $(SRCDIR)/*.[ch] $@
	cp $(SRCDIR)/*.sh $@

$(distdir)/$(TESTDIR):
	mkdir -p $@
	cp $(TESTDIR)/Makefile.in $@
	cp $(TESTDIR)/*.c $@
	cp $(TESTDIR)/*.sh $@
	cp $(TESTDIR)/testdata $@
	cp $(TESTDIR)/testoutput $@
	for d in $(DATADIR); do (cp -r $(TESTDIR)/$$d $@ ); done

$(distdir)/$(INCDIR):
	mkdir -p $@
	cp $(INCDIR)/Makefile.in $@
	cp $(INCDIR)/*.h $@

$(distdir)/$(HDRDIR):
	mkdir -p $@
	cp $(HDRDIR)/Makefile.in $@
	cp $(HDRDIR)/*.h $@

$(distdir)/$(MANDIR):
	mkdir -p $@
	cp $(HDRDIR)/Makefile.in $@
	cp $(MANDIR)/*.3 $@

$(distdir): FORCE \
            $(distdir)/$(SRCDIR)\
            $(distdir)/$(MANDIR)\
            $(distdir)/$(TESTDIR)\
            $(distdir)/$(INCDIR)\
            $(distdir)/$(HDRDIR)
	mkdir -p $@
	cp Makefile.in $(FILES) $(SCRIPTS) $@

FORCE:
	-rm $(distdir).tar.gz >/dev/null 2>&1
	-rm -rf $(distdir) >/dev/null 2>&1

distcheck: $(distdir).tar.gz
	gzip -cd $(distdir).tar.gz | tar xvf -
	cd $(distdir) && ./configure
	cd $(distdir) && $(MAKE) all
	cd $(distdir) && $(MAKE) check
	cd $(distdir) && $(MAKE) DESTDIR=$${PWD}/_inst install
	cd $(distdir) && $(MAKE) DESTDIR=$${PWD}/_inst uninstall
	@remaining="`find $${PWD}/$(distdir)/_inst -type f | wc -l`"; \
	if test "$${remaining}" -ne 0; then \
	echo "*** $${remaining} file(s) remaining in staging directory!";\
	exit 1; \
	fi
	cd $(distdir) && $(MAKE) clean
	rm -rf $(distdir)
	@echo "*** Package $(distdir).tar.gz is ready for distribution ***"
	
Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

.PHONY: FORCE all check clean dist distcheck install uninstall

# vim: noexpandtab
